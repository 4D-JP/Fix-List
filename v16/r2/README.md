4D v16 R2
---

Nightly Build ``209092``

* ACI0096318 Windows版のみ。リストボックスのセルに長文が表示されており，列のプロパティでワードワップが有効にされている場合，途中からテキストが表示されないことがありました。

* ACI0096290 Mac版のみ。テキストまたは文字列フィールドがリストフォームに表示されており，テキスト全文を表示するだけの幅がない場合，テキストの始めが省略されました。期待されるのは，テキストの終わりが省略されることです。

* ACI0096338 ``GET SERIAL INFORMATION``から返されるシリアルキー番号は，サーバー側とクライアント側で同じではありませんでした。

* ACI0096295 64ビット版のみ。メソッドエディター内でメソッド・コマンド・フォーム・変数にカーソルが置かれていれば，ショートカット``command``+``K``でその定義を開くことができるはずです。しかし，v16の64ビット版では，メソッド名全体をハイライト選択しているのでない限り，対象の定義を開くことができませんでした。

* ACI0096145 Windows版のみ。システムのアピアランステーマが「クラシック」に設定されている場合，非フォーカスリストボックスの選択されたセルが正しく表示されませんでした。

* ACI0096113 リストボックスのセルに表示された数値を``backspace``キーで削除した後，``tab``キーでセルを抜け出ると，消したはずの値がまた表示されました。日付でも同じことが起きますが，テキストでは問題ありません。

* ACI0096138 Windows版のみ。リストボックスのセル内で``Ttb``文字が表示されませんでした。

* ACI0096157 リストボックスのセルに文字列をペーストした場合，On After Editイベントが発生しませんでした。

* ACI0096259 Mac 64ビット版のみ。システム環境設定でプリンターが1台も登録されていない場合，ラベルエディターの「プレビュー」ボタンをクリックするとアプリケーションがクラッシュしました。

* ACI0095137 フォームエディターで複数のテキスト入力オブジェクトを水平方向に均等配置した場合，オブジェクトのサイズが変化することがありました。

* ACI0085050 Bootcampで起動したWindowsをMacのRetinaディスプレイに表示した場合，デバッガのツールバーが表示されませんでした。通常のWindowsでは問題ありません。

* ACI0096092 Windows版のみ。``4D_OPTION_BLOCKING_EXTERNAL_PROCESS``オプションが指定された場合，``LAUNCH EXTERNAL PROCESS``で外部アプリケーションを起動することができませんでした。

* ACI0096184 外部ファイルのユーザー設定が有効にされている場合，ビルドされたクライアント/サーバーのネットワーク通信ポートを実行中に変更すると，クライアントがクラッシュしました。

* ACI0096035 Windows版のみ。サービス起動した4D Serverを停止するとエラーメッセージが返されました。

* ACI0096078 ACI0096078 ポップアップメニューの項目に空の文字列が存在する場合，0番項目の代わりにその項目が選択されました。

* ACI0096235 フォームエディターのツールボタンでオブジェクトの入力順だけを変更した場合，変更内容が保存されませんでした。

* ACI0096227 クライアントで``Is field value null``コマンドを使用した場合，常に``False``が返されました。

* ACI0096154 Mac版のみ。複数行を表示できるテキスト入力エリアに，巨大なオブジェクト型データ（フィールドまたは変数）を表示すると，画面のリフレッシュに時間がかかったり，アプリケーションがクラッシュしたりました。表示できるオブジェクト型データの最大サイズは，テキスト入力エリアの幅に比例するようです。高さには左右されません。

* ACI0094528 Windows版のみ。マトリクスプリンター「Dascom 2600」に搭載されているプリンターフォントはプロパティリストに表示されませんでした。ツールボックス > スタイルシートには表示されます。

**注記**: 64ビット版では，印刷にデフォルトでDirect2Dテクノロジーが使用されます。画面には，Direct2Dに対応したフォントしか表示できないため，その大半がTrueTypeまたはOpenTypeであるプリンターフォントはフォームエディターのプロパティリストに含まれていませんでした。64ビット版でDirect2Dに対応していないフォントをフォームに使用することもできますが，画面と印刷の出力を一致させるためには，旧式のGDI印刷を有効にすることが勧められています。

```
SET PRINT OPTION(Legacy printing layer option;1)
```

* ACI0094537 ``FTP_GetDirList``は，6ヶ月以上前に更新されたファイルの更新時間を正しく返しませんでした。

* ACI0095712 リストボックスの自動アクションに「ページ移動」を設定した場合，クリックイベントでしかアクションが実行されませんでした。オブジェクトがフォーカス可であれば，上下矢印キーでも操作できるはずです。

**注記**: ページ移動後，リストボックスにフォーカスがとどまるようにするためには，下記のようなコードが必要です。

```
If (Form event=On Page Change)
    GOTO OBJECT(*;"List Box")
End if 
```

* ACI0095899 Mac版のみ。配列型リストボックスのヘッダータイトルは，ソートされているカラムだけ垂直揃えが上揃えになりました。

* ACI0095403 64ビット版のみ。プロパティリストで設定したヘルプTipsがストラクチャに保存されませんでした。

* ACI0096179 クライアント/サーバーモードで``QUERY BY ATTRIBUTE``の後に``Get last query path``または``Get last query plan``を実行した場合，クエリパスやクエリプランが返されませんでした。

* ACI0095532 Windows 64ビット版のみ。``Open form window``と``Movable form dialog box``の組み合わせで表示したウインドウは，最大化・最小化ボタンをクリックしても何も起きませんでした。

* ACI0096063 ラベルのテキストが常に左揃えで印字されました。

* ACI0095470 新ネットワークレイヤーのみ。30秒ほどクライアントマシンをスリープさせてからマシンのスリープを解除した場合，4Dがスリープから復帰しませんでした。

* ACI0095550 メソッドエディターで取り消し/やり直し（``command``+``Z``, ``command``+``shift``+``Z``）操作をすると，日本語変換途中の各候補が表示されました。

* ACI0095871 Mac版のみ。リストボックスのセルは，内容を編集している間だけ右揃えが左揃えになりました。

* ACI0095994 ``GOTO OBJECT``の速度がv13と比較してずっと遅くなりました。

* ACI0096161 64ビット版のみ。メソッドエディターにコードをタイプ入力を開始しても，ツールTipsが消えませんでした。

* ACI0096274 アップグレード後，4Dが内部的に使用しているフランス語の変数/定数の大部分が失われてしまいました。

* ACI0096296 ``Transaction active``は，フランス語版のコマンド名でした。英語版のコマンド名は``Active transaction``です。

* ACI0096236 非表示行が含まれるリストボックス上で``Shift``キーを押しながら一定の範囲を選択した場合，あるいは``command``+``A``で全体を選択した場合，非表示行も選択に含まれました。画面に表示されていない行は，選択から除外されるべきでした。

* ACI0096323 64ビット版のみ。``SET DATABASE PARAMETER``に続けて``SET CACHE SIZE``を使用した場合，キャッシュのサイズが変更されませんでした。``SET DATABASE PARAMETER``を使用しなければ問題ありません。

**注記**: データベース設定をダイアログまたはコマンドで変更した後，キャッシュ設定が自動的に更新されないようになりました。64ビット版に限り，『起動時にキャッシュサイズを計算』オプションが有効にされていないときは，データベース設定の『メモリ』ページに『適用』ボタンが表示されます。データベース設定のキャッシュサイズを採用するためには，このボタンをクリックしてください。

* ACI0096365 64ビット版のみ。起動直後のインデックス最構築に時間がかかりました。

**注記**: キャッシュサイズが反映される前にインデックス作成プロセスが開始していることが原因でした。修正により，キャッシュはストラクチャファイルを開いた後，データファイルを開く前に確保されるようになりました。

* ACI0096430 複合インデックスと非インデックスフィールドの両方が関係するクエリを実行すると，アプリケーションがクラッシュしました。v15.3では問題ありません。v15.4の不具合です。単独のシーケンシャルクエリ，および複合インデックスが利用できる``AND``クエリでは，問題ありません。両方（合計3個のフィールド）を組み合わせたクエリで問題が起きました。

* ACI0096325 Mac版のみ。リストボックスの中央寄せヘッダーのタイトル表示位置が正しくありませんでした。ACI0095899が修正されたことの副作用です。

* ACI0095979 スレッドセーフであるはずのXMLコマンド（DOMおよびSAX）のスレッドセーフ属性が正しく返されませんでした。

**注記**: コマンドがスレッドセーフ（プリエンプティブプロセスで実行できる）かどうかは，``Command name``で調べることができます。また，ドキュメントにアイコンが表示されるいることでも確認できます。

![preemption xx](https://cloud.githubusercontent.com/assets/10509075/23443824/b345f95c-fe74-11e6-8dc6-057a5bf3e675.png)

* ACI0096191 Windows版のみ。最近のシステム更新（``10.1607.14393.576``, ``10.1511.10586.713``）以降，リストボックスのダブルクリック操作で入力フォームに移行した直後，『ロックされたレコード』ダイアログが表示されると，4Dが表示している領域以外は画面が真っ黒に表示されました。

* ACI0096144 オブジェクト型フィールドに対して中``QUERY BY ATTRIBUTE``でクエリを実行した場合，クライアント/サーバー版では，日付属性の値が``null``または存在しないレコードはヒットしませんでした。

* ACI0096137 macOS Sierra 10.12.1 (16B2657) のみ。一旦，デスクトップをクリックした後，Welcomeウィザードの背景部分をクリックすると，アプリケーションがクラッシュしました。リンクをクリックした場合は問題ありません。

**注記**: WebKitが修正されました。

* ACI0096150  macOS Sierraのみ。4D Writeエリアをクリックしてアクティブにすると，アプリケーションがクラッシュしました。TouchBar搭載マシンでなければ問題ありません。

* ACI0073896 ``PRINT SELECTION``で印刷を実行した場合，プリントダイアログに入力した終了ページ番号は反映されますが，開始ベージ番号は無視されました。

* ACI0095427 Windows 10のみ。リストボックスのセルや一般的なテキスト入力オブジェクト（変数またはフィールドに）日本語入力メソッドを使用してテキストを入力した場合，文末の文字がスペース（全角または半角）だとカーソルの点滅が停止し，カーソルの位置がわからなくなります。

* ACI0095432 4D Write ProからエクスポートしたMIMEテキストは，[RFC2822](https://tools.ietf.org/html/rfc2822)で勧められているように，1行の長さが998ですが，一部のメールサーバーは，78行以内でなければメッセージを処理することができません。

* ACI0095452 クイックレポートエディター上でセルを選択しても，ツールバーの状態が更新されませんでした。

* ACI0095463 保存オプションが『データファイルの中』に設定されている場合，ストラクチャエディター上でフィールドのタイプをオブジェクトからテキストに変更することができませんでした。テキストではなく，文字列になりました。 保存オプションが『レコードと一緒』に設定されていれば，フィールドのタイプをオブジェクトからテキストに変更することができます。しかし，タイプをオブジェクトの戻すと，保存オプションも『データファイルの中』に戻りました。

* ACI0095490 Mac版の32ビットクライアントからWindows版の64ビットサーバーに何度も接続を試みていると，ランタイムエラー``-50``が返されることがありました。通常の操作では，なかなか再現しません。スクリプトを使用して，接続と切断を高速に繰り返すと，再現性が上がります。ネットワークレイヤー『旧式』で問題が発生します。クライアント/サーバーの接続タイムアウトは1時間くらいに設定すると発生しやすいようです。

**参考**: ``4DLink``ファイルを用意し，下記のようなAppleScriptでサーバーに接続することができます。

```applescript
set x to 0
repeat 20 times
    tell application "Finder"
    activate
    open document file "$(DatabaseName).4DLink" of ¬
    folder "Remote" of folder "Favorites v16" of folder "4D" of ¬
    folder "Application Support" of folder "Library" of ¬
    folder $(UserName) of folder "Users" of startup disk
    delay (10)
    tell application "4D"
        quit
    end tell
    set x to x + 1
    display notification (x)
    end tell
end repeat
```

* ACI0095496 SQLの``INTO LISTBOX``でレコードをリストボックスに表示した場合，フッターの計算が正しくないことがありました。実数型フィールドの合計値などが整数に変換されてしまうためです。

* ACI0095525 検索ワードの途中にワイルドカード記号が使用された場合，キーワード検索で合致するのは，単語レベルで条件に合致するレコードではなく，テキスト全体で条件に合致するレコードでした。たとえば，name%"B@que"のようなクエリを実行した場合，"Banque Cantonale Vaudoise"や"Union de Banque Suisse"だけでなく，"Bureau Informatique"もヒットしました。

**注記**: 修正により，検索ワードの途中にワイルドカード記号が使用された場合，キーワードインデックスに基づいたシーケンシャルクエリが実行されるようになりました。

* ACI0095533 デザインモードに切り替えた直後，どのテーブルがカレントテーブルであっても，テーブルリスト上は第1テーブルが選択されていました。

* ACI0095538 Windows 64ビット版のみ。MDIの子ウィンドウが最大化されている場合，MDIウィンドウのリサイズが困難になりました。リサイズボックスがウィンドウの角に表示されるため，ドラッグできる範囲が非常に狭くなってしまいました。

* ACI0095540 mac版のみ。ランタイムエクスプローラーが表示された状態で4D Serverを終了すると，アプリケーションがクラッシュしました。

* ACI0095543 Windows版のみ。``AP Print settings to BLOB``を初めて実行すると，アプリケーションがクラッシュしました。クラッシュした後は，システムを再起動するまで問題ありません。

* ACI0095544 Windows 64ビット版のみ。MDIの子ウィンドウをリサイズしている間，ウィンドウの中に表示されている内容がちらつきました。

* ACI0095558 Mac 64ビット版のみ。リストボックスのセルに入力している日本語の変換を確定するために``return``キーを押すと，セルの編集が終わりました。

* ACI0095559 Mac 64ビット版のみ。階層リストのアイテムに入力している日本語の変換を確定するために``return``キーを押すと，アイテムの編集が終わりました。

* ACI0095574 Mac 32ビット版のみ。ピクチャオブジェクトに画像をドラッグ＆ドロップ操作で入力すると，``PICT``形式で画像が保存されました。

**注記**: 32ビット版の場合，``PICT``形式の画像を表示することはできますが，印刷することはできません。修正により，ドロップ操作された画像は，すべての画像フォーマットが取り出されます。ペーストボードに複数の画像フォーマットが含まれている場合，オリジナルの形式がどれなのかを判断することはできないためです。

* ACI0095577 Mac版のみ。``Select document``は，特定のUTIに関連付けられていない拡張子を無視しました。たとえば，``rsrc``や``fp7``のような拡張子のファイルを指定することができませんでした。

* ACI0095581 Mac版のみ。リストボックスのセルに日本語を入力，未確定のまま別のエリアにフォーカスを移動すると，入力中の未確定文字列が失われました。

* ACI0095582 Windows 64ビット版のみ。入力された日本語を``backspace``または``delete``キーで削除しようとすると，最後の1文字だけ2度キーを押す必要がありました。

* ACI0095610 ウイルス退治ソフトウェア（McAfeeなど）により，自動アップグレードが阻まれることがありました。

**注記**: [Process Monitor](https://technet.microsoft.com/ja-jp/sysinternals/processmonitor.aspx)でファイルアクセスを監視すると，自動アップデート中にMcAfeeが一瞬だけ4DCファイルにアクセスしていることが確認できます。終了直前に4DCファイルが書き換えられることに反応しているようです。ファイルがロックされているため，古いアプリケーションを移動することができず，自動アップグレードに失敗しました。

* ACI0088073 プロセスでトランザクションを開始してロードした「リレートしたNレコードを削除」オプションが有効にされたレコードを削除した後にトランザクションをキャンセルした場合，そのプロセスが動作している間は，新規プロセスから前のプロセスがロックしたセレクション内のレコードを削除することができませんでした。

**注記**: リレートしたNレコードを削除オプションが有効にされている場合，データベースエンジンは内部的にトランザクションを開始し，セレクションの削除を試みます。しかし，これをトランザクション内で実行した場合，トランザクションをキャンセルしても，内部的に開始された第2段階のトランザクションがロックしたレコードがプロセスによってロックされたままになりました。つまり，第2段階のトランザクション内でレコードを削除してから第2段階のトランザクションを確定し，第1段階のトランザクションをキャンセルした場合，削除を取りやめたレコードがそのプロセスによってロックされたままになる，という問題がありました。

```
START TRANSACTION
START TRANSACTION
QUERY([configs];[configs]id=2)
DELETE SELECTION([configs])
VALIDATE TRANSACTION 
CANCEL TRANSACTION
```

* ACI0088156 ``SMTP_Attachment``で追加した添付ファイルは，``Content-Disposition``が``attachment``で挿入されるため，一部のメールクライアント（Apple Mailなど）では，本文の後に繰り返し表示されました。``Content-Disposition``が``inline``であれば問題ありません。

* ACI0095614 64ビット版のみ。読み込み/書き出しダイアログは，選択したエンコーディングではなく，常に``utf-8``にデータを変換しました。プロジェクト内でエンコーディングを指定すれば問題ありません。

* ACI0091212 ``QUERY SELECTION``でクエリエディターを表示した場合，絞り込みではない，通常のクエリも実行できました。「クエリ」関係のオプションはクリック不可になるべきです。

* ACI0091658 ``SET TABLE TITLES``でテーブルタイトルを設定した後，クエリエディターを表示した場合，マスターテーブルにN対1リレーションが定義されていると，余計な空のテーブル名（``[]``）が表示されました。

* ACI0091900 データベース間で入力フォームを移動した場合，ヘルプTipsが一緒に移動しませんでした。

* ACI0092274 ``ON EVENT CALL``を中止する（イベントマネージャープロセスを通常にプロセスに切り替える）ためのキーコンビネーション（Windows版は``Control``+``Shift``+``Backspace`` Mac版は``command``+``shift``+``control``+``backspace``）が効きませんでした。

* ACI0092571 ユーザー設定が使用されている場合，アップグレード後に互換性オプションの「旧ネットワークレイヤーを使用する」が解除されました。

* ACI0095618 リストボックスにロックされた列が存在する場合，垂直スクロールバーが動作しないことがありました。

* ACI0095621 フォームエディター上の操作でマーカーを追加した場合，プロパティリストに新しいマーカーの項目が追加されませんでした。

* ACI0093483 フォームに4D Write Proエリアが置かれており，詳細マーカーが用紙のサイズよりも下に定義されている場合，``Print form``でそのフォームを印刷すると，最初に空のページが出力されました。
