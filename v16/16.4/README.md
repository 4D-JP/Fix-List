## 4D v16.4
[4D v16.3 Hotfix 1](https://github.com/4D-JP/release-notes/tree/master/v16/16.3/hf1/)の修正事項もご覧ください。

![jp](https://cloud.githubusercontent.com/assets/10509075/16182979/016305e0-36e7-11e6-816b-2335cc6f0abb.png)

* ACI0097778 ``BASE64 ENCODE``から返される文字列は，``40,000``文字ごとに改行コード``CR`` ``LF``が挿入されました。

* ACI0097787 v15で作成したリストボックスをv16に変換した場合，フッター変数の「型」が正しくありませんでした。数値型に設定されていたものがテキスト型になりました。

**注記**: v15では「変数タイプ」メニューの末尾に表示された「なし」が，v16ではメニューの冒頭に表示されるようになったことが原因でした。そのため，変換されたストラクチャでは，ポップアップメニューの位置番号と保存されたプロパティ値のマッピングに食い違いが発生していました。この問題は，下記のように是正されています：

1. v15から変換されたフッターの「変数タイプ」には，実際のプロパティ値が表示されます。

1. 修正前のv16で作成されたフッターの「変数タイプ」メニューをクリックすると，実際のプロパティとは違う項目が選択された状態でリストが表示されます。したがって，本来の値を改めて選択しなければなりません。

1. フッターの水平揃えは，変数タイプに応じたものが適用され，変数も正しい型で初期化されます。修正前はそうではありませんでした。

---

* ACI0097715 64ビット版のみ。テーブルに非表示フィールドが存在する場合，そのフィールド以降のフィールドタイトルがクイックレポートエディターに正しく表示されませんでした。

* ACI0097390 ``On Web Connection``データベースメソッドで``WEB SEND TEXT``の後に``QUERY SELECTION``がコールされた場合，アプリケーションがクラッシュしました。

* ACI0097838 オブジェクト型フィールドのスカラー属性に対する4D Mobileクエリの結果が正しくありませんでした。

* ACI0097483 新ネットワークレイヤーのみ。4D Serverに対して大勢（40以上）のクライアントが一挙に接続しようとした場合，4D Serverが無反応になりました。

**注記**: 内部スケジューラー（コオペレティブスレッド）の実装に問題がありました。通常，スケジューラーは停止中・遅延中・非表示ではないアクティブなプロセスを探し，CPU時間を与えます。そして，すべてのアクティブなプロセスにCPU時間が与えられたところで，スケジューラーはシステムに制御を戻します。今回の状況では，スケジューラーが過剰に呼ばれ，CPU時間の大半がシステムに与えられ，サーバーが処理を進めるための時間がほとんど残されていませんでした。加えて，通信速度の遅いクライアントが存在した場合，そのクライアントとの接続が他の接続すべての足を引っ張っていた問題も修正されました。

* ACI0097539 大量のSOAPリクエストを処理すると，サーバーが突然に終了することがありました。サーバー側で管理画面を表示していると，さらに問題が起こりやすくなるようです。

* ACI0097859 Windows版のみ。リストボックスの行の高さを「行」単位で指定し，サイズ``12``または``18``の``MS Sans Serif``フォントを設定した場合，``p``, ``q``, ``g``のような文字の「ぶらさがり」が途切れて表示されました。サイズ``14``では問題ありません。リストボックスのテキストレンダリングが「DirectWrite」の場合に問題が発生します。「GDI」であれば問題ありません。

**注記**: レンダリングの違いによって発生する「ずれ」の度合いは，使用するフォントによって異なりますが，ほとんどの場合，それは1ピクセル程度の違いです。しかし，GDIだけでサポートされているフォントの場合，DirectWriteでは代替フォントが使用されるため，かなりの違いが発生することがあります。TrueTypeでもOpenTypeでもない，``Terminal``や``Roman``のようなビットマップフォントがこれに相当します。なお，リストボックスのレンダリングモードは，データベースパラメーター``107``で変更することができます。

0: バージョン15以前に作成されたリストボックスであればGDI，16以降で作成されたリストボックスであればDirectWriteを使用します。（デフォルト）

1: 常にDirectWriteを使用します。

2: 常にGDIを使用します。

* ACI0097726 クイックレポートの印刷をキャンセルした場合，``OK``システム変数が``0``にセットされませんでした。

* ACI0096656 ``IMAP_Search``を使用して``Message-ID``ヘッダーでメッセージを検索した場合，対象になるはずのメッセージが結果に含まれないことがありました。

* ACI0097764 64ビット版のみ。フォームエディターのプロパティリスト上で「すべて選択（``Control``/``command``+``A``）」に続けて「コピー（``Control``/``command``+``C``）」の操作をした場合，初回はうまく行かず，もう一度，操作をする必要がありました。矢印キーなどでテキスト範囲を選択した場合は問題ありません。リストボックス内でテキストを入力した直後に「すべて選択」を実行すると問題が発生します。

* ACI0097882 PHPのODBC経由で日付型のデータを4Dから取り出した場合，（v12やv13のように）時間ではなく，タイムスタンプ型で返されました。

* ACI0097867 Window版のみ。最大化されたウィンドウで``MODIFY RECORD``を実行した場合，画面が正しく再描画されませんでした。

* ACI0097722 64ビット版のみ。クイックレポートエリアをフォームに組み込んだ場合，4D Viewのライセンスが必要になりました。

* ACI0097831 親フォームの背後に隠れてしまった子ウィンドウをスペースバーで前面に移動することができませんでした。

* ACI0097826 Windows版のみ。ビルドしたアプリケーションにカスタマイズされたアイコン（``.ico``）を設定しても，サーバー管理画面やランタイムエクスプローラーにはそのアイコンが表示されませんでした。

* ACI0097785 問題のあるメソッドを削除することにより，画面に収まらないウィンドウ座標が``ObjectMethodEditor.json``ファイルに書き込まれ，以後，新規に作成したメソッドが画面に表示されなくなることがありました。

* ACI0097934 Mac 64ビット版のみ。``GRAPH``で作成したグラフ画像をコンテキストメニューの「コピー」で転写することができませんでした。``graphNumber``でグラフ番号を指定した場合に問題があります。``graphSettings``オブジェクトで設定した場合は問題ありません。

* ACI0097706 テーブルタイトルやフィールドタイトルが設定されている場合，その名称をクエリエディターのフォーミュラーに含めるとシンタックスエラーが返されました。``SET TABLE TITLES``や``SET FIELD TITLES``に``*``オプションが渡されたのであれば，仮想ストラクチャの参照をフォーミュラーに含めても良いはずです。

**注記**: ``_4D Parse formula``が隠しコマンドとしてv16で実装されました。

* ACI0097882 PHPのODBC経由で日付型のデータを4Dから取り出した場合，（v12やv13のように）時間ではなく，タイムスタンプ型で返されました。
